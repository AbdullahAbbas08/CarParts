<!-- Add/Edit Offer Modal -->
<div class="modal-overlay" *ngIf="isVisible" (click)="onClose()">
  <div class="modal-container" (click)="$event.stopPropagation()">
    <!-- Modal Header -->
    <div class="modal-header">
      <div class="header-content">
        <h2 class="modal-title">
          <i class="fas" [class]="editingOffer ? 'fa-edit' : 'fa-plus-circle'"></i>
          {{ editingOffer ? 'تعديل العرض' : 'إضافة عرض جديد' }}
        </h2>
        <p class="modal-subtitle">
          {{ editingOffer ? 'قم بتعديل بيانات العرض' : 'قم بإدخال تفاصيل العرض الجديد' }}
        </p>
      </div>
      <button type="button" class="close-btn" (click)="onClose()" aria-label="إغلاق">
        <i class="fas fa-times"></i>
      </button>
    </div>

    <!-- Form Content -->
    <form [formGroup]="offerForm" (ngSubmit)="onSubmit()" class="offer-form">
      <div class="form-content">
        
        <!-- Basic Information Section -->
        <div class="form-section">
          <h3 class="section-title">
            <i class="fas fa-info-circle"></i>
            المعلومات الأساسية
          </h3>
          <p class="section-help">أدخل المعلومات الأساسية للعرض</p>
          
          <div class="form-grid">
            <div class="form-group">
              <label class="form-label" for="type">نوع العرض *</label>
              <select
                id="type"
                formControlName="type"
                class="form-control"
                [class.error]="hasError('type')"
                (change)="onTypeChange($event)"
              >
                <option value="0">سعر جديد</option>
                <option value="1">خصم نسبة مئوية</option>
                <option value="2">خصم مبلغ ثابت</option>
                <option value="3">اشتري X خذ Y</option>
                <option value="4">باقة قطع</option>
              </select>
              <div class="error-message" *ngIf="hasError('type')">
                {{ getFieldError('type') }}
              </div>
              <small class="form-help" *ngIf="getOfferTypeDescription()">
                {{ getOfferTypeDescription() }}
              </small>
            </div>

            <div class="form-group">
              <label class="form-label" for="partId">اختيار القطعة *</label>
              
              <!-- حقل البحث في القطع -->
              <div class="search-container" style="margin-bottom: 0.5rem;">
                <input
                  type="text"
                  placeholder="البحث في القطع بالاسم أو الكود..."
                  class="form-control search-input"
                  (input)="onPartSearch($event)"
                  style="font-size: 0.875rem; padding: 0.5rem 1rem;"
                />
                <i class="fas fa-search search-icon"></i>
              </div>
              
              <div class="select-container">
                <select
                  id="partId"
                  formControlName="partId"
                  class="form-control"
                  [class.error]="hasError('partId')"
                  [disabled]="isLoadingParts"
                >
                  <option value="" disabled selected>اختر القطعة...</option>
                  <option *ngFor="let part of filteredParts" [value]="part.id">
                    {{ part.name }} ({{ part.code }}) - {{ part.price }} ج.م
                  </option>
                </select>
                <div class="loading-indicator" *ngIf="isLoadingParts">
                  <i class="fas fa-spinner fa-spin"></i> جاري التحميل...
                </div>
              </div>
              
              <!-- عرض السعر الحالي للقطعة المختارة -->
              <div class="part-price-info" *ngIf="offerForm.get('partId')?.value && getPartPrice(offerForm.get('partId')?.value)">
                <small class="text-info">
                  <i class="fas fa-info-circle"></i>
                  السعر الحالي: {{ getPartPrice(offerForm.get('partId')?.value) }} ج.م
                </small>
              </div>
              
              <div class="error-message" *ngIf="hasError('partId')">
                {{ getFieldError('partId') }}
              </div>
            </div>
          </div>
        </div>

        <!-- Offer Details Section -->
        <div class="form-section">
          <h3 class="section-title">
            <i class="fas fa-percentage"></i>
            تفاصيل العرض
          </h3>
          <p class="section-help">حدد قيمة العرض والتفاصيل المطلوبة حسب النوع المختار</p>
          
          <!-- Debug info - يمكن إزالته لاحقاً -->
          <div style="background: #f0f0f0; padding: 10px; margin: 10px 0; border-radius: 5px;">
            <strong>Debug:</strong> نوع العرض الحالي = {{ offerForm.get('type')?.value }}
          </div>

          <!-- New Price Field -->
          <div class="form-group" *ngIf="shouldShowNewPriceField()">
            <label class="form-label" for="newPrice">السعر الجديد *</label>
            <input
              type="number"
              id="newPrice"
              formControlName="newPrice"
              class="form-control"
              [class.error]="hasError('newPrice')"
              placeholder="مثال: 150.00"
              min="0.01"
              step="0.01"
            />
            <div class="error-message" *ngIf="hasError('newPrice')">
              {{ getFieldError('newPrice') }}
            </div>
            <small class="form-help">السعر الجديد الذي سيتم تطبيقه على القطعة</small>
          </div>

          <!-- Discount Rate Field -->
          <div class="form-group" *ngIf="shouldShowDiscountRateField()">
            <label class="form-label" for="discountRate">نسبة الخصم (%) *</label>
            <input
              type="number"
              id="discountRate"
              formControlName="discountRate"
              class="form-control"
              [class.error]="hasError('discountRate')"
              placeholder="مثال: 25"
              min="0.01"
              max="100"
              step="0.01"
            />
            <div class="error-message" *ngIf="hasError('discountRate')">
              {{ getFieldError('discountRate') }}
            </div>
            <small class="form-help">نسبة الخصم من السعر الأصلي (من 0.01% إلى 100%)</small>
          </div>

          <!-- Fixed Amount Field -->
          <div class="form-group" *ngIf="shouldShowFixedAmountField()">
            <label class="form-label" for="fixedAmount">مبلغ الخصم الثابت *</label>
            <input
              type="number"
              id="fixedAmount"
              formControlName="fixedAmount"
              class="form-control"
              [class.error]="hasError('fixedAmount')"
              placeholder="مثال: 50.00"
              min="0.01"
              step="0.01"
            />
            <div class="error-message" *ngIf="hasError('fixedAmount')">
              {{ getFieldError('fixedAmount') }}
            </div>
            <small class="form-help">المبلغ الثابت الذي سيتم خصمه من السعر الأصلي</small>
          </div>

          <!-- Buy X Get Y Fields -->
          <div class="form-grid" *ngIf="shouldShowQuantityFields()">
            <div class="form-group">
              <label class="form-label" for="buyQuantity">كمية الشراء المطلوبة *</label>
              <input
                type="number"
                id="buyQuantity"
                formControlName="buyQuantity"
                class="form-control"
                [class.error]="hasError('buyQuantity')"
                placeholder="مثال: 2"
                min="1"
              />
              <div class="error-message" *ngIf="hasError('buyQuantity')">
                {{ getFieldError('buyQuantity') }}
              </div>
              <small class="form-help">عدد القطع المطلوب شراؤها</small>
            </div>

            <div class="form-group">
              <label class="form-label" for="getQuantity">كمية الحصول المجاني *</label>
              <input
                type="number"
                id="getQuantity"
                formControlName="getQuantity"
                class="form-control"
                [class.error]="hasError('getQuantity')"
                placeholder="مثال: 1"
                min="1"
              />
              <div class="error-message" *ngIf="hasError('getQuantity')">
                {{ getFieldError('getQuantity') }}
              </div>
              <small class="form-help">عدد القطع التي سيحصل عليها العميل مجاناً</small>
            </div>
          </div>

          <!-- Free Part ID for Buy X Get Y -->
          <div class="form-group" *ngIf="shouldShowQuantityFields()">
            <label class="form-label" for="freePartId">رقم القطعة المجانية (اختياري)</label>
            <input
              type="number"
              id="freePartId"
              formControlName="freePartId"
              class="form-control"
              placeholder="اتركه فارغاً لنفس القطعة"
              min="1"
            />
            <small class="form-help">إذا تركته فارغاً، ستكون القطعة المجانية هي نفس قطعة الشراء</small>
          </div>

          <!-- Bundle Field -->
          <div class="form-group" *ngIf="shouldShowBundleField()">
            <label class="form-label" for="bundlePartIdsCsv">أرقام قطع الحزمة *</label>
            <textarea
              id="bundlePartIdsCsv"
              formControlName="bundlePartIdsCsv"
              class="form-control textarea"
              rows="2"
              placeholder="مثال: 1,2,3,4,5"
              [class.error]="hasError('bundlePartIdsCsv')"
            ></textarea>
            <div class="error-message" *ngIf="hasError('bundlePartIdsCsv')">
              {{ getFieldError('bundlePartIdsCsv') }}
            </div>
            <small class="form-help">أدخل أرقام القطع مفصولة بفاصلة (,) مثل: 1,2,3,4</small>
          </div>
        </div>

        <!-- Date Settings Section -->
        <div class="form-section">
          <h3 class="section-title">
            <i class="fas fa-calendar-alt"></i>
            إعدادات التاريخ
          </h3>
          <p class="section-help">حدد فترة صلاحية العرض</p>

          <div class="form-grid">
            <div class="form-group">
              <label class="form-label" for="startAt">تاريخ البداية *</label>
              <input
                type="date"
                id="startAt"
                formControlName="startAt"
                class="form-control"
                [class.error]="hasError('startAt')"
              />
              <div class="error-message" *ngIf="hasError('startAt')">
                {{ getFieldError('startAt') }}
              </div>
            </div>

            <div class="form-group">
              <label class="form-label" for="endAt">تاريخ النهاية *</label>
              <input
                type="date"
                id="endAt"
                formControlName="endAt"
                class="form-control"
                [class.error]="hasError('endAt')"
              />
              <div class="error-message" *ngIf="hasError('endAt')">
                {{ getFieldError('endAt') }}
              </div>
            </div>
          </div>
        </div>

        <!-- Status Section -->
        <div class="form-section">
          <h3 class="section-title">
            <i class="fas fa-toggle-on"></i>
            حالة العرض
          </h3>
          <p class="section-help">تحكم في حالة تفعيل العرض</p>

          <div class="form-grid">
            <div class="form-group">
              <div class="checkbox-container">
                <input
                  type="checkbox"
                  id="isActive"
                  formControlName="isActive"
                  class="checkbox-input"
                />
                <label for="isActive" class="checkbox-label">
                  <span class="checkmark"></span>
                  العرض نشط ومتاح للعملاء
                </label>
              </div>
              <small class="form-help">قم بإلغاء التحديد لإيقاف العرض مؤقتاً</small>
            </div>

            <div class="form-group" *ngIf="editingOffer">
              <label class="form-label">تاريخ الإنشاء</label>
              <input
                type="text"
                class="form-control"
                [value]="editingOffer.createdOn | date:'short':'ar-EG'"
                readonly
              />
              <small class="form-help">تاريخ إنشاء العرض</small>
            </div>
          </div>
        </div>

      </div>

      <!-- Form Actions -->
      <div class="form-actions">
        <button type="button" class="btn btn-secondary" (click)="onClose()">
          <i class="fas fa-times"></i>
          إلغاء
        </button>
        <button type="submit" class="btn btn-primary" [disabled]="!offerForm.valid">
          <i class="fas" [class]="editingOffer ? 'fa-save' : 'fa-plus'"></i>
          {{ editingOffer ? 'حفظ التعديلات' : 'إضافة العرض' }}
        </button>
      </div>
    </form>
  </div>
</div>
